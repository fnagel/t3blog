From f39225414a98adef4b01dc82caf791066a8c9e0d Mon Sep 17 00:00:00 2001
From: Felix Nagel <info@felixnagel.com>
Date: Sun, 10 Jun 2012 01:05:32 +0200
Subject: [PATCH 6/8] fixed: Hidden posts cannot be previewed, see:
 http://forge.typo3.org/issues/9131

---
 pi1/lib/class.t3blog_db.php                    |    4 ++--
 pi1/widgets/blogList/class.singleFunctions.php |   20 ++++++++++----------
 2 files changed, 12 insertions(+), 12 deletions(-)

diff --git a/pi1/lib/class.t3blog_db.php b/pi1/lib/class.t3blog_db.php
index 8f1aab0..a1b99fb 100644
--- a/pi1/lib/class.t3blog_db.php
+++ b/pi1/lib/class.t3blog_db.php
@@ -52,9 +52,9 @@ class t3blog_db {
 	 * @param	string	$limit: sql-limit clause
 	 * @return 	array	if has, db records from the db, else return false boolean
 	 */
-	static public function getRecFromDbJoinTables($table, $selectFields , $where = '1=1', $order='', $limit = ''){
+	static public function getRecFromDbJoinTables($table, $selectFields , $where = '1=1', $order='', $limit = '', $showHidden = 0){
 		$tablePost = 'tx_t3blog_post';
-		$where .= self::$cObj->enableFields($tablePost);
+		$where .= self::$cObj->enableFields($tablePost, $showHidden);
 
 		$result = $GLOBALS['TYPO3_DB']->exec_SELECTgetRows($selectFields,
 			$table, $where, '', $order, $limit
diff --git a/pi1/widgets/blogList/class.singleFunctions.php b/pi1/widgets/blogList/class.singleFunctions.php
index cef32ab..27792ec 100644
--- a/pi1/widgets/blogList/class.singleFunctions.php
+++ b/pi1/widgets/blogList/class.singleFunctions.php
@@ -83,16 +83,16 @@ class singleFunctions extends blogList {
 		if ($this->uid) {
 			$this->riseViewNumber();
 
-			$row = $this->fetchPostDataFromDatabase();
+			if ($this->isBEUserLoggedIn()) {
+				// Allow preview for hidden posts
+				$showHiddenPosts = 1;
+			} else {
+				$showHiddenPosts = 0;
+			}
 
-			if (is_array($row)) {
-
-				$showHiddenRecords = $GLOBALS['TSFE']->showHiddenRecords;
-				if ($this->isBEUserLoggedIn()) {
-					// Allow preview for hidden posts
-					$GLOBALS['TSFE']->showHiddenRecords = true;
-				}
+			$row = $this->fetchPostDataFromDatabase($showHiddenPosts);
 
+			if (is_array($row)) {
 				$this->updatePageTitle($row['title']);
 				$this->setSomePiVarValues($row);
 
@@ -172,11 +172,11 @@ class singleFunctions extends blogList {
 	 *
 	 * @return mixed Array or null if no data
 	 */
-	protected function fetchPostDataFromDatabase() {
+	protected function fetchPostDataFromDatabase($showHiddenRecords = 0) {
 		list($row) = t3blog_db::getRecFromDbJoinTables(
 			'tx_t3blog_post, be_users',  //  TABLES
 			'tx_t3blog_post.uid as postuid, tx_t3blog_post.title, tx_t3blog_post.tagClouds,tx_t3blog_post.author, tx_t3blog_post.date, tx_t3blog_post.cat, tx_t3blog_post.allow_comments,tx_t3blog_post.number_views, be_users.uid, be_users.username, be_users.email, be_users.admin, be_users.admin, be_users.realName, be_users.uid AS useruid, be_users.lastlogin, be_users.tx_t3blog_avatar',
-			'tx_t3blog_post.uid='.t3lib_div::intval_positive($this->uid).' AND (be_users.uid=tx_t3blog_post.author)'
+			'tx_t3blog_post.uid='.t3lib_div::intval_positive($this->uid).' AND (be_users.uid=tx_t3blog_post.author)', '', '', $showHiddenRecords
 		);
 		return $row;
 	}
-- 
1.7.5.GIT

